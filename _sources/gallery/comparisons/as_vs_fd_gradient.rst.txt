
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "gallery/comparisons/as_vs_fd_gradient.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_gallery_comparisons_as_vs_fd_gradient.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_gallery_comparisons_as_vs_fd_gradient.py:


4. Adjoint-state vs. FD gradient
================================

The **gradient of the misfit function**, as implemented in `emg3d`, uses the
adjoint-state method following [PlMu08]_ (see :func:`emg3d.optimize.gradient`).
The method has the advantage that it is very fast. However, it can be tricky to
implement and it is always good to verify the implementation against another
method.

We compare in this example the adjoint-state gradient to a simple forward
finite-difference gradient. (See :ref:`sphx_glr_gallery_tutorials_gradient.py`
for more details regarding the adjoint-state gradient.)

.. GENERATED FROM PYTHON SOURCE LINES 16-24

.. code-block:: default

    import emg3d
    import itertools
    import numpy as np
    import matplotlib.pyplot as plt
    from matplotlib.patches import Rectangle
    from matplotlib.colors import LogNorm, SymLogNorm









.. GENERATED FROM PYTHON SOURCE LINES 26-36

1. Create a survey and a simple model
-------------------------------------

Create a simple block model and a survey for the comparison.

Survey
''''''
The survey consists of one source, one receiver, both electric, x-directed
point-dipoles, where the receiver is on the seafloor and the source 50 m
above. Offset is 3.2 km, and acquisition frequency is 1 Hz.

.. GENERATED FROM PYTHON SOURCE LINES 36-46

.. code-block:: default


    survey = emg3d.surveys.Survey(
        name='Gradient Test-Survey',
        sources=emg3d.TxElectricDipole((-1600, 0, -1950, 0, 0)),
        receivers=emg3d.RxElectricPoint((1600, 0, -2000, 0, 0)),
        frequencies=1.0,
        noise_floor=1e-15,
        relative_error=0.05,
    )








.. GENERATED FROM PYTHON SOURCE LINES 47-54

Model
'''''

As `emg3d` internally computes with conductivities we use conductivities to
compare the gradient in its purest implementation. Note that if we define our
model in terms of resistivities or :math:`\log_{\{e;10\}}(\{\sigma;\rho\})`,
the gradient would look differently.

.. GENERATED FROM PYTHON SOURCE LINES 54-74

.. code-block:: default


    # Create a simple block model.
    hx = np.array([1000, 1500, 1000, 1500, 1000])
    hy = np.array([1000, 1500, 1000, 1500, 1000])
    hz = np.array([1800., 200., 200., 200., 300., 300., 2000.,  500.])
    model_grid = emg3d.TensorMesh(
            [hx, hy, hz], origin=np.array([-3000, -3000, -5000]))

    # Initiate model with conductivities of 1 S/m.
    model = emg3d.Model(
            model_grid, np.ones(model_grid.n_cells), mapping='Conductivity')
    model.property_x[:, :, -1] = 1e-8  # Add air layer.
    model.property_x[:, :, -2] = 3.33  # Add seawater layer.
    model_bg = model.copy()  # Make a copy for the background model.

    # Add three blocks.
    model.property_x[1, 1:3, 1:3] = 0.02
    model.property_x[3, 2:4, 2:4] = 0.01
    model.property_x[2, 1:4, 4] = 0.005








.. GENERATED FROM PYTHON SOURCE LINES 75-77

QC
''

.. GENERATED FROM PYTHON SOURCE LINES 77-94

.. code-block:: default


    model_grid.plot_3d_slicer(model.property_x.ravel('F'), zslice=-2900,
                              pcolor_opts={'norm': LogNorm(vmin=0.002, vmax=3.5)})

    plt.suptitle('Conductivity (S/m)')
    axs = plt.gcf().get_children()
    rec_coords = survey.receiver_coordinates()
    src_coords = survey.source_coordinates()
    axs[1].plot(rec_coords[0], rec_coords[1], 'bv')
    axs[2].plot(rec_coords[0], rec_coords[2], 'bv')
    axs[3].plot(rec_coords[2], rec_coords[1], 'bv')
    axs[1].plot(src_coords[0], src_coords[1], 'r*')
    axs[2].plot(src_coords[0], src_coords[2], 'r*')
    axs[3].plot(src_coords[2], src_coords[1], 'r*')
    plt.show()





.. image:: /gallery/comparisons/images/sphx_glr_as_vs_fd_gradient_001.png
    :alt: Conductivity (S/m)
    :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 95-97

Generate synthetic data
-----------------------

.. GENERATED FROM PYTHON SOURCE LINES 97-125

.. code-block:: default


    # Gridding options.
    gridding_opts = {
        'frequency': survey.frequencies['f-1'],
        'properties': [3.33, 1, 1, 3.33],
        'center': (0, 0, -2000),
        'min_width_limits': 100,
        'domain': ([-2000, 2000], [-2000, 2000], [-3200, -2000]),
        'mapping': model.map,
    }

    data_grid = emg3d.construct_mesh(**gridding_opts)

    # Define a simulation for the data.
    simulation_data = emg3d.simulations.Simulation(
        name='Data for Gradient Test',
        survey=survey,
        model=model.interpolate_to_grid(data_grid),
        gridding='same',  # Same grid as for input model.
        max_workers=4,
    )

    # Simulate the data and store them as observed.
    simulation_data.compute(observed=True)

    # Let's print the survey to check that the observed data are now set.
    survey





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Compute efields:           0/1  [00:00]    Compute efields: ##########1/1  [00:15]    Compute efields: ##########1/1  [00:15]


.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <h3>Survey «Gradient Test-Survey»</h3><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
    <defs>
    <symbol id="icon-database" viewBox="0 0 32 32">
    <path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
    <path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
    <path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
    </symbol>
    <symbol id="icon-file-text2" viewBox="0 0 32 32">
    <path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
    <path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
    <path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
    <path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
    </symbol>
    </defs>
    </svg>
    <style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
     *
     */

    :root {
      --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
      --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
      --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
      --xr-border-color: var(--jp-border-color2, #e0e0e0);
      --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
      --xr-background-color: var(--jp-layout-color0, white);
      --xr-background-color-row-even: var(--jp-layout-color1, white);
      --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
    }

    html[theme=dark],
    body.vscode-dark {
      --xr-font-color0: rgba(255, 255, 255, 1);
      --xr-font-color2: rgba(255, 255, 255, 0.54);
      --xr-font-color3: rgba(255, 255, 255, 0.38);
      --xr-border-color: #1F1F1F;
      --xr-disabled-color: #515151;
      --xr-background-color: #111111;
      --xr-background-color-row-even: #111111;
      --xr-background-color-row-odd: #313131;
    }

    .xr-wrap {
      display: block;
      min-width: 300px;
      max-width: 700px;
    }

    .xr-text-repr-fallback {
      /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
      display: none;
    }

    .xr-header {
      padding-top: 6px;
      padding-bottom: 6px;
      margin-bottom: 4px;
      border-bottom: solid 1px var(--xr-border-color);
    }

    .xr-header > div,
    .xr-header > ul {
      display: inline;
      margin-top: 0;
      margin-bottom: 0;
    }

    .xr-obj-type,
    .xr-array-name {
      margin-left: 2px;
      margin-right: 10px;
    }

    .xr-obj-type {
      color: var(--xr-font-color2);
    }

    .xr-sections {
      padding-left: 0 !important;
      display: grid;
      grid-template-columns: 150px auto auto 1fr 20px 20px;
    }

    .xr-section-item {
      display: contents;
    }

    .xr-section-item input {
      display: none;
    }

    .xr-section-item input + label {
      color: var(--xr-disabled-color);
    }

    .xr-section-item input:enabled + label {
      cursor: pointer;
      color: var(--xr-font-color2);
    }

    .xr-section-item input:enabled + label:hover {
      color: var(--xr-font-color0);
    }

    .xr-section-summary {
      grid-column: 1;
      color: var(--xr-font-color2);
      font-weight: 500;
    }

    .xr-section-summary > span {
      display: inline-block;
      padding-left: 0.5em;
    }

    .xr-section-summary-in:disabled + label {
      color: var(--xr-font-color2);
    }

    .xr-section-summary-in + label:before {
      display: inline-block;
      content: '►';
      font-size: 11px;
      width: 15px;
      text-align: center;
    }

    .xr-section-summary-in:disabled + label:before {
      color: var(--xr-disabled-color);
    }

    .xr-section-summary-in:checked + label:before {
      content: '▼';
    }

    .xr-section-summary-in:checked + label > span {
      display: none;
    }

    .xr-section-summary,
    .xr-section-inline-details {
      padding-top: 4px;
      padding-bottom: 4px;
    }

    .xr-section-inline-details {
      grid-column: 2 / -1;
    }

    .xr-section-details {
      display: none;
      grid-column: 1 / -1;
      margin-bottom: 5px;
    }

    .xr-section-summary-in:checked ~ .xr-section-details {
      display: contents;
    }

    .xr-array-wrap {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 20px auto;
    }

    .xr-array-wrap > label {
      grid-column: 1;
      vertical-align: top;
    }

    .xr-preview {
      color: var(--xr-font-color3);
    }

    .xr-array-preview,
    .xr-array-data {
      padding: 0 5px !important;
      grid-column: 2;
    }

    .xr-array-data,
    .xr-array-in:checked ~ .xr-array-preview {
      display: none;
    }

    .xr-array-in:checked ~ .xr-array-data,
    .xr-array-preview {
      display: inline-block;
    }

    .xr-dim-list {
      display: inline-block !important;
      list-style: none;
      padding: 0 !important;
      margin: 0;
    }

    .xr-dim-list li {
      display: inline-block;
      padding: 0;
      margin: 0;
    }

    .xr-dim-list:before {
      content: '(';
    }

    .xr-dim-list:after {
      content: ')';
    }

    .xr-dim-list li:not(:last-child):after {
      content: ',';
      padding-right: 5px;
    }

    .xr-has-index {
      font-weight: bold;
    }

    .xr-var-list,
    .xr-var-item {
      display: contents;
    }

    .xr-var-item > div,
    .xr-var-item label,
    .xr-var-item > .xr-var-name span {
      background-color: var(--xr-background-color-row-even);
      margin-bottom: 0;
    }

    .xr-var-item > .xr-var-name:hover span {
      padding-right: 5px;
    }

    .xr-var-list > li:nth-child(odd) > div,
    .xr-var-list > li:nth-child(odd) > label,
    .xr-var-list > li:nth-child(odd) > .xr-var-name span {
      background-color: var(--xr-background-color-row-odd);
    }

    .xr-var-name {
      grid-column: 1;
    }

    .xr-var-dims {
      grid-column: 2;
    }

    .xr-var-dtype {
      grid-column: 3;
      text-align: right;
      color: var(--xr-font-color2);
    }

    .xr-var-preview {
      grid-column: 4;
    }

    .xr-var-name,
    .xr-var-dims,
    .xr-var-dtype,
    .xr-preview,
    .xr-attrs dt {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 10px;
    }

    .xr-var-name:hover,
    .xr-var-dims:hover,
    .xr-var-dtype:hover,
    .xr-attrs dt:hover {
      overflow: visible;
      width: auto;
      z-index: 1;
    }

    .xr-var-attrs,
    .xr-var-data {
      display: none;
      background-color: var(--xr-background-color) !important;
      padding-bottom: 5px !important;
    }

    .xr-var-attrs-in:checked ~ .xr-var-attrs,
    .xr-var-data-in:checked ~ .xr-var-data {
      display: block;
    }

    .xr-var-data > table {
      float: right;
    }

    .xr-var-name span,
    .xr-var-data,
    .xr-attrs {
      padding-left: 25px !important;
    }

    .xr-attrs,
    .xr-var-attrs,
    .xr-var-data {
      grid-column: 1 / -1;
    }

    dl.xr-attrs {
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: 125px auto;
    }

    .xr-attrs dt,
    .xr-attrs dd {
      padding: 0;
      margin: 0;
      float: left;
      padding-right: 10px;
      width: auto;
    }

    .xr-attrs dt {
      font-weight: normal;
      grid-column: 1;
    }

    .xr-attrs dt:hover span {
      display: inline-block;
      background: var(--xr-background-color);
      padding-right: 10px;
    }

    .xr-attrs dd {
      grid-column: 2;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .xr-icon-database,
    .xr-icon-file-text2 {
      display: inline-block;
      vertical-align: middle;
      width: 1em;
      height: 1.5em !important;
      stroke-width: 0;
      stroke: currentColor;
      fill: currentColor;
    }
    </style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
    Dimensions:    (freq: 1, rec: 1, src: 1)
    Coordinates:
      * src        (src) &lt;U6 &#x27;TxED-1&#x27;
      * rec        (rec) &lt;U6 &#x27;RxEP-1&#x27;
      * freq       (freq) &lt;U3 &#x27;f-1&#x27;
    Data variables:
        observed   (src, rec, freq) complex128 (-1.2683637614533435e-13+8.8464452...
        synthetic  (src, rec, freq) complex128 (-1.4820509840973293e-13+9.9197176...
    Attributes:
        noise_floor:     1e-15
        relative_error:  0.05</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-fbc1759c-5a73-4ec5-976d-31c991951cca' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-fbc1759c-5a73-4ec5-976d-31c991951cca' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>freq</span>: 1</li><li><span class='xr-has-index'>rec</span>: 1</li><li><span class='xr-has-index'>src</span>: 1</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-30dc1945-c6bb-403a-9a84-b81ca5b73b38' class='xr-section-summary-in' type='checkbox'  checked><label for='section-30dc1945-c6bb-403a-9a84-b81ca5b73b38' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>src</span></div><div class='xr-var-dims'>(src)</div><div class='xr-var-dtype'>&lt;U6</div><div class='xr-var-preview xr-preview'>&#x27;TxED-1&#x27;</div><input id='attrs-cc2ab82e-a635-40c7-a163-89c6d07de8f1' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-cc2ab82e-a635-40c7-a163-89c6d07de8f1' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c18b316b-3afb-46ff-ac37-cee4ff3020da' class='xr-var-data-in' type='checkbox'><label for='data-c18b316b-3afb-46ff-ac37-cee4ff3020da' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>Sources :</span></dt><dd>TxED-1: TxElectricDipole: 1.0 A;
        center={-1,600.0; 0.0; -1,950.0} m; θ=0.0°, φ=0.0°; l=1.0 m.</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;TxED-1&#x27;], dtype=&#x27;&lt;U6&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>rec</span></div><div class='xr-var-dims'>(rec)</div><div class='xr-var-dtype'>&lt;U6</div><div class='xr-var-preview xr-preview'>&#x27;RxEP-1&#x27;</div><input id='attrs-31143cc6-8176-42b8-b5af-a40ea0996161' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-31143cc6-8176-42b8-b5af-a40ea0996161' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-9e39e3f4-2dd4-4125-bb5a-863371baa15a' class='xr-var-data-in' type='checkbox'><label for='data-9e39e3f4-2dd4-4125-bb5a-863371baa15a' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>Receivers :</span></dt><dd>RxEP-1: RxElectricPoint: absolute;
        x=1,600.0 m, y=0.0 m, z=-2,000.0 m, θ=0.0°, φ=0.0°.</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;RxEP-1&#x27;], dtype=&#x27;&lt;U6&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>freq</span></div><div class='xr-var-dims'>(freq)</div><div class='xr-var-dtype'>&lt;U3</div><div class='xr-var-preview xr-preview'>&#x27;f-1&#x27;</div><input id='attrs-8ec9530b-0559-4c3f-899b-230104aa5640' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-8ec9530b-0559-4c3f-899b-230104aa5640' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4277c512-cab7-414d-9f36-77bec1d03568' class='xr-var-data-in' type='checkbox'><label for='data-4277c512-cab7-414d-9f36-77bec1d03568' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>Frequencies :</span></dt><dd>f-1: 1.0 Hz.</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;f-1&#x27;], dtype=&#x27;&lt;U3&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-63786095-c936-4854-9b3e-b26573fb8c97' class='xr-section-summary-in' type='checkbox'  checked><label for='section-63786095-c936-4854-9b3e-b26573fb8c97' class='xr-section-summary' >Data variables: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>observed</span></div><div class='xr-var-dims'>(src, rec, freq)</div><div class='xr-var-dtype'>complex128</div><div class='xr-var-preview xr-preview'>(-1.2683637614533435e-13+8.84644...</div><input id='attrs-24de1cd6-bc29-4ce8-8bb6-4e8b6f8b0f77' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-24de1cd6-bc29-4ce8-8bb6-4e8b6f8b0f77' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f0e9a239-a4ff-4a0d-9099-1587aae8445e' class='xr-var-data-in' type='checkbox'><label for='data-f0e9a239-a4ff-4a0d-9099-1587aae8445e' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[-1.26836376e-13+8.84644527e-14j]]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>synthetic</span></div><div class='xr-var-dims'>(src, rec, freq)</div><div class='xr-var-dtype'>complex128</div><div class='xr-var-preview xr-preview'>(-1.4820509840973293e-13+9.91971...</div><input id='attrs-152b0b92-5340-4821-b8c6-cb5d2688553f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-152b0b92-5340-4821-b8c6-cb5d2688553f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d14d8146-e413-4cda-8dfe-13f930f57adb' class='xr-var-data-in' type='checkbox'><label for='data-d14d8146-e413-4cda-8dfe-13f930f57adb' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[-1.48205098e-13+9.91971764e-14j]]])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-6477be1b-1bab-4a41-bb2f-4cbd3536cd5b' class='xr-section-summary-in' type='checkbox'  checked><label for='section-6477be1b-1bab-4a41-bb2f-4cbd3536cd5b' class='xr-section-summary' >Attributes: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>noise_floor :</span></dt><dd>1e-15</dd><dt><span>relative_error :</span></dt><dd>0.05</dd></dl></div></li></ul></div></div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 126-139

Adjoint-state gradient
----------------------

For the actual comparison we use a very coarse mesh. The reason is that we
have to compute an extra forward model for each cell for the forward
finite-difference approximation, so we try to keep that number low (even
though we only do a cross-section, not the entire cube).

Our computational grid has only 16,384 cells, which should be fast enough to
compute the FD gradient of a cross-section in a few minutes. A
cross-section along the survey-line has :math:`32 \times 11 = 352` cells, so
we need to compute an extra 352 forward models. (There are 16 cells in z, but
only 11 below the seafloor.)

.. GENERATED FROM PYTHON SOURCE LINES 139-159

.. code-block:: default


    # Computational grid (min_width 200 instead of 100).
    comp_grid_opts = {**gridding_opts, 'min_width_limits': 200}
    comp_grid = emg3d.construct_mesh(**comp_grid_opts)

    # Interpolate the background model onto the computational grid.
    comp_model = model_bg.interpolate_to_grid(comp_grid)

    # AS gradient simulation.
    simulation_as = emg3d.simulations.Simulation(
        name='AS Gradient Test',
        survey=survey,
        model=comp_model,
        gridding='same',  # Same grid as for input model.
        max_workers=4,    # For parallel workers, adjust if you have more.
        receiver_interpolation='linear',  # For proper adjoint-state gradient
    )

    simulation_as






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <h3>Simulation «AS Gradient Test»</h3><ul>  <li>Survey «Gradient Test-Survey»:    1 sources;    1 receivers;    1 frequencies</li>  <li>Model: conductivity; isotropic; 32 x 32 x 16 (16,384)</li>  <li>Gridding: Same grid as for model;     32 x 32 x 16 (16,384)</li></ul>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 160-169

.. code-block:: default


    # Get the misfit and the gradient of the misfit.
    data_misfit = simulation_as.misfit
    as_grad = simulation_as.gradient

    # Set water and air gradient to NaN for the plots.
    as_grad[:, :, comp_grid.cell_centers_z > -2000] = np.nan






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Compute efields:           0/1  [00:00]    Compute efields: ##########1/1  [00:01]    Compute efields: ##########1/1  [00:01]
    Back-propagate :           0/1  [00:00]    Back-propagate : ##########1/1  [00:01]    Back-propagate : ##########1/1  [00:01]




.. GENERATED FROM PYTHON SOURCE LINES 170-182

Finite-Difference gradient
--------------------------

To test if the adjoint-state gradient indeed returns the gradient we can
compare it to a one-sided finite-difference approximated gradient as given by

.. math::
        \left(\nabla_p J \left(\textbf{p}\right)\right)_{FD} =
        \frac{J(\textbf{p}+\epsilon) - J(\textbf{p})}{\epsilon} \ .

Define a fct to compute FD gradient for one cell
''''''''''''''''''''''''''''''''''''''''''''''''

.. GENERATED FROM PYTHON SOURCE LINES 182-217

.. code-block:: default


    # Define epsilon (some small conductivity value, S/m).
    epsilon = 0.0001

    # Define the cross-section.
    iy = comp_grid.shape_cells[1]//2


    def comp_fd_grad(ixiz):
        """Compute forward-FD gradient for one cell."""

        # Copy the computational model.
        fd_model = comp_model.copy()

        # Add conductivity-epsilon to this (ix, iy, iz) cell.
        fd_model.property_x[ixiz[0], iy, ixiz[1]] += epsilon

        # Create a new simulation with this model
        simulation_fd = emg3d.simulations.Simulation(
            name='FD Gradient Test',
            survey=survey, model=fd_model, gridding='same',
            max_workers=1, solver_opts={'verb': 1},
            receiver_interpolation='linear',  # For proper adjoint-state gradient
        )

        # Switch-of progress bar in this case
        simulation_fd._tqdm_opts['disable'] = True

        # Get misfit
        fd_data_misfit = simulation_fd.misfit

        # Return gradient
        return float((fd_data_misfit - data_misfit)/epsilon)









.. GENERATED FROM PYTHON SOURCE LINES 218-220

Loop over all required cells
''''''''''''''''''''''''''''

.. GENERATED FROM PYTHON SOURCE LINES 220-242

.. code-block:: default


    # Initiate FD gradient.
    fd_grad = np.zeros_like(as_grad)

    # Get all ix-iz combinations (without air/water).
    ixiz = list(itertools.product(
        range(comp_grid.shape_cells[0]),
        range(len(comp_grid.cell_centers_z[comp_grid.cell_centers_z < -2000])))
    )

    # Wrap it asynchronously
    out = emg3d.utils._process_map(
            comp_fd_grad,
            ixiz,
            max_workers=4,  # Adjust max worker here!
    )

    # Collect result
    for i, (ix, iz) in enumerate(ixiz):
        fd_grad[ix, iy, iz] = out[i]






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

      0%|          | 0/352 [00:00<?, ?it/s]      0%|          | 1/352 [00:03<20:10,  3.45s/it]      1%|          | 2/352 [00:03<08:51,  1.52s/it]      1%|          | 3/352 [00:03<05:17,  1.10it/s]      1%|1         | 4/352 [00:03<03:38,  1.59it/s]      1%|1         | 5/352 [00:07<08:54,  1.54s/it]      2%|1         | 7/352 [00:07<04:59,  1.15it/s]      2%|2         | 8/352 [00:07<03:57,  1.45it/s]      3%|2         | 9/352 [00:11<08:05,  1.41s/it]      3%|3         | 11/352 [00:11<04:58,  1.14it/s]      4%|3         | 13/352 [00:14<06:16,  1.11s/it]      4%|3         | 14/352 [00:14<05:03,  1.11it/s]      4%|4         | 15/352 [00:14<04:12,  1.33it/s]      5%|4         | 16/352 [00:15<03:33,  1.57it/s]      5%|4         | 17/352 [00:18<07:05,  1.27s/it]      5%|5         | 18/352 [00:18<05:38,  1.01s/it]      6%|5         | 20/352 [00:18<03:37,  1.52it/s]      6%|5         | 21/352 [00:21<06:20,  1.15s/it]      6%|6         | 22/352 [00:22<06:18,  1.15s/it]      7%|7         | 25/352 [00:25<05:21,  1.02it/s]      7%|7         | 26/352 [00:26<05:37,  1.04s/it]      8%|7         | 27/352 [00:26<04:49,  1.12it/s]      8%|8         | 29/352 [00:30<06:18,  1.17s/it]      9%|8         | 30/352 [00:31<06:32,  1.22s/it]      9%|9         | 33/352 [00:34<05:30,  1.04s/it]     10%|9         | 34/352 [00:34<05:18,  1.00s/it]     10%|9         | 35/352 [00:35<04:27,  1.18it/s]     11%|#         | 37/352 [00:38<06:04,  1.16s/it]     11%|#         | 38/352 [00:38<04:59,  1.05it/s]     12%|#1        | 41/352 [00:42<05:35,  1.08s/it]     13%|#2        | 45/352 [00:45<05:00,  1.02it/s]     13%|#3        | 46/352 [00:46<04:32,  1.12it/s]     13%|#3        | 47/352 [00:46<03:59,  1.27it/s]     14%|#3        | 49/352 [00:49<05:08,  1.02s/it]     14%|#4        | 50/352 [00:49<04:31,  1.11it/s]     14%|#4        | 51/352 [00:49<03:41,  1.36it/s]     15%|#4        | 52/352 [00:50<03:20,  1.49it/s]     15%|#5        | 53/352 [00:53<05:58,  1.20s/it]     15%|#5        | 54/352 [00:53<05:16,  1.06s/it]     16%|#5        | 55/352 [00:54<04:19,  1.14it/s]     16%|#6        | 57/352 [00:57<05:28,  1.11s/it]     16%|#6        | 58/352 [00:57<04:31,  1.08it/s]     17%|#7        | 60/352 [00:58<03:19,  1.46it/s]     17%|#7        | 61/352 [01:00<05:19,  1.10s/it]     18%|#7        | 62/352 [01:01<04:40,  1.03it/s]     18%|#8        | 64/352 [01:01<03:31,  1.36it/s]     18%|#8        | 65/352 [01:04<05:10,  1.08s/it]     19%|#8        | 66/352 [01:05<04:56,  1.04s/it]     19%|#9        | 68/352 [01:05<03:17,  1.43it/s]     20%|#9        | 69/352 [01:08<05:18,  1.13s/it]     20%|#9        | 70/352 [01:08<04:29,  1.05it/s]     20%|##        | 71/352 [01:08<03:44,  1.25it/s]     20%|##        | 72/352 [01:09<03:41,  1.27it/s]     21%|##        | 73/352 [01:12<06:45,  1.45s/it]     21%|##1       | 74/352 [01:13<05:32,  1.20s/it]     21%|##1       | 75/352 [01:13<04:32,  1.02it/s]     22%|##1       | 76/352 [01:14<04:08,  1.11it/s]     22%|##1       | 77/352 [01:16<05:17,  1.15s/it]     22%|##2       | 78/352 [01:16<04:30,  1.01it/s]     22%|##2       | 79/352 [01:17<03:33,  1.28it/s]     23%|##2       | 80/352 [01:18<04:11,  1.08it/s]     23%|##3       | 81/352 [01:20<05:30,  1.22s/it]     23%|##3       | 82/352 [01:20<04:07,  1.09it/s]     24%|##3       | 83/352 [01:21<03:54,  1.15it/s]     24%|##3       | 84/352 [01:22<03:49,  1.17it/s]     24%|##4       | 85/352 [01:24<05:41,  1.28s/it]     24%|##4       | 86/352 [01:24<04:22,  1.01it/s]     25%|##4       | 87/352 [01:26<05:08,  1.16s/it]     25%|##5       | 88/352 [01:26<04:23,  1.00it/s]     25%|##5       | 89/352 [01:28<04:40,  1.06s/it]     26%|##5       | 90/352 [01:28<03:36,  1.21it/s]     26%|##5       | 91/352 [01:29<04:15,  1.02it/s]     26%|##6       | 92/352 [01:30<03:30,  1.24it/s]     26%|##6       | 93/352 [01:31<04:04,  1.06it/s]     27%|##6       | 94/352 [01:31<03:05,  1.39it/s]     27%|##6       | 95/352 [01:33<04:05,  1.05it/s]     27%|##7       | 96/352 [01:33<03:43,  1.15it/s]     28%|##7       | 97/352 [01:34<03:39,  1.16it/s]     28%|##7       | 98/352 [01:35<03:42,  1.14it/s]     28%|##8       | 99/352 [01:37<05:15,  1.25s/it]     28%|##8       | 100/352 [01:38<04:49,  1.15s/it]     29%|##8       | 101/352 [01:39<04:50,  1.16s/it]     29%|##8       | 102/352 [01:40<03:39,  1.14it/s]     29%|##9       | 103/352 [01:42<05:20,  1.29s/it]     30%|##9       | 104/352 [01:42<04:25,  1.07s/it]     30%|##9       | 105/352 [01:44<05:41,  1.38s/it]     30%|###       | 107/352 [01:46<04:56,  1.21s/it]     31%|###       | 108/352 [01:47<04:01,  1.01it/s]     31%|###       | 109/352 [01:49<05:25,  1.34s/it]     32%|###1      | 111/352 [01:51<04:48,  1.20s/it]     32%|###1      | 112/352 [01:51<03:53,  1.03it/s]     32%|###2      | 113/352 [01:53<04:51,  1.22s/it]     33%|###2      | 115/352 [01:55<04:18,  1.09s/it]     33%|###2      | 116/352 [01:55<03:32,  1.11it/s]     33%|###3      | 117/352 [01:57<04:08,  1.06s/it]     34%|###3      | 118/352 [01:57<03:12,  1.22it/s]     34%|###3      | 119/352 [01:59<04:05,  1.05s/it]     34%|###4      | 121/352 [02:00<03:32,  1.09it/s]     35%|###4      | 122/352 [02:01<03:00,  1.28it/s]     35%|###4      | 123/352 [02:02<03:14,  1.18it/s]     35%|###5      | 124/352 [02:02<03:00,  1.26it/s]     36%|###5      | 125/352 [02:04<03:43,  1.02it/s]     36%|###5      | 126/352 [02:04<02:47,  1.35it/s]     36%|###6      | 127/352 [02:05<03:24,  1.10it/s]     36%|###6      | 128/352 [02:06<03:13,  1.16it/s]     37%|###6      | 129/352 [02:07<03:37,  1.03it/s]     37%|###6      | 130/352 [02:08<02:57,  1.25it/s]     37%|###7      | 131/352 [02:09<03:23,  1.09it/s]     38%|###7      | 132/352 [02:09<02:55,  1.26it/s]     38%|###7      | 133/352 [02:11<03:41,  1.01s/it]     38%|###8      | 134/352 [02:11<02:58,  1.22it/s]     38%|###8      | 135/352 [02:12<03:01,  1.20it/s]     39%|###8      | 136/352 [02:13<02:41,  1.33it/s]     39%|###8      | 137/352 [02:14<03:53,  1.09s/it]     39%|###9      | 138/352 [02:15<02:57,  1.21it/s]     39%|###9      | 139/352 [02:16<03:03,  1.16it/s]     40%|####      | 141/352 [02:18<03:19,  1.06it/s]     40%|####      | 142/352 [02:18<03:03,  1.14it/s]     41%|####      | 143/352 [02:19<02:47,  1.25it/s]     41%|####      | 144/352 [02:19<02:25,  1.43it/s]     41%|####1     | 145/352 [02:21<03:28,  1.01s/it]     41%|####1     | 146/352 [02:22<03:17,  1.04it/s]     42%|####1     | 147/352 [02:22<02:42,  1.26it/s]     42%|####2     | 148/352 [02:23<02:19,  1.46it/s]     42%|####2     | 149/352 [02:25<03:18,  1.02it/s]     43%|####2     | 150/352 [02:25<03:06,  1.08it/s]     43%|####2     | 151/352 [02:26<02:50,  1.18it/s]     43%|####3     | 152/352 [02:26<02:12,  1.51it/s]     43%|####3     | 153/352 [02:28<03:34,  1.08s/it]     44%|####3     | 154/352 [02:29<03:08,  1.05it/s]     44%|####4     | 155/352 [02:29<02:27,  1.33it/s]     44%|####4     | 156/352 [02:30<02:18,  1.41it/s]     45%|####4     | 157/352 [02:32<03:26,  1.06s/it]     45%|####4     | 158/352 [02:32<03:03,  1.06it/s]     45%|####5     | 159/352 [02:33<02:35,  1.24it/s]     45%|####5     | 160/352 [02:33<02:24,  1.33it/s]     46%|####5     | 161/352 [02:35<03:10,  1.00it/s]     46%|####6     | 162/352 [02:36<02:54,  1.09it/s]     46%|####6     | 163/352 [02:36<02:39,  1.18it/s]     47%|####6     | 164/352 [02:37<02:09,  1.45it/s]     47%|####6     | 165/352 [02:39<03:21,  1.08s/it]     47%|####7     | 166/352 [02:39<02:51,  1.09it/s]     47%|####7     | 167/352 [02:40<02:24,  1.28it/s]     48%|####7     | 168/352 [02:41<02:36,  1.18it/s]     48%|####8     | 169/352 [02:43<03:30,  1.15s/it]     48%|####8     | 170/352 [02:43<02:53,  1.05it/s]     49%|####8     | 171/352 [02:44<02:50,  1.06it/s]     49%|####8     | 172/352 [02:45<02:55,  1.03it/s]     49%|####9     | 173/352 [02:47<03:20,  1.12s/it]     49%|####9     | 174/352 [02:47<02:39,  1.12it/s]     50%|####9     | 175/352 [02:48<02:23,  1.23it/s]     50%|#####     | 176/352 [02:49<02:45,  1.07it/s]     50%|#####     | 177/352 [02:50<02:56,  1.01s/it]     51%|#####     | 178/352 [02:50<02:23,  1.21it/s]     51%|#####     | 179/352 [02:51<02:35,  1.12it/s]     51%|#####1    | 180/352 [02:52<02:38,  1.09it/s]     51%|#####1    | 181/352 [02:54<02:49,  1.01it/s]     52%|#####1    | 182/352 [02:54<02:30,  1.13it/s]     52%|#####1    | 183/352 [02:55<02:26,  1.15it/s]     52%|#####2    | 184/352 [02:56<02:31,  1.11it/s]     53%|#####2    | 185/352 [02:57<02:41,  1.03it/s]     53%|#####2    | 186/352 [02:58<02:27,  1.13it/s]     53%|#####3    | 187/352 [02:59<02:17,  1.20it/s]     53%|#####3    | 188/352 [03:00<02:37,  1.04it/s]     54%|#####3    | 189/352 [03:01<02:52,  1.06s/it]     54%|#####3    | 190/352 [03:01<02:16,  1.19it/s]     54%|#####4    | 191/352 [03:02<02:25,  1.11it/s]     55%|#####4    | 192/352 [03:03<02:27,  1.09it/s]     55%|#####4    | 193/352 [03:05<02:43,  1.03s/it]     55%|#####5    | 194/352 [03:05<02:15,  1.16it/s]     55%|#####5    | 195/352 [03:06<02:09,  1.21it/s]     56%|#####5    | 196/352 [03:07<02:34,  1.01it/s]     56%|#####5    | 197/352 [03:09<02:48,  1.08s/it]     56%|#####6    | 198/352 [03:09<02:23,  1.07it/s]     57%|#####6    | 199/352 [03:10<02:08,  1.19it/s]     57%|#####6    | 200/352 [03:11<02:22,  1.07it/s]     57%|#####7    | 201/352 [03:13<03:08,  1.25s/it]     58%|#####7    | 203/352 [03:14<02:02,  1.21it/s]     58%|#####7    | 204/352 [03:15<02:38,  1.07s/it]     58%|#####8    | 205/352 [03:17<02:52,  1.17s/it]     59%|#####8    | 207/352 [03:18<02:09,  1.12it/s]     59%|#####9    | 208/352 [03:19<02:11,  1.10it/s]     59%|#####9    | 209/352 [03:20<02:26,  1.03s/it]     60%|#####9    | 211/352 [03:21<01:41,  1.39it/s]     60%|######    | 212/352 [03:22<01:40,  1.39it/s]     61%|######    | 213/352 [03:22<01:42,  1.36it/s]     61%|######    | 214/352 [03:23<01:30,  1.52it/s]     61%|######1   | 215/352 [03:24<01:48,  1.26it/s]     61%|######1   | 216/352 [03:25<01:41,  1.34it/s]     62%|######1   | 217/352 [03:25<01:26,  1.56it/s]     62%|######2   | 219/352 [03:26<01:31,  1.46it/s]     62%|######2   | 220/352 [03:27<01:40,  1.31it/s]     63%|######2   | 221/352 [03:28<01:21,  1.62it/s]     63%|######3   | 223/352 [03:29<01:24,  1.52it/s]     64%|######3   | 224/352 [03:30<01:30,  1.42it/s]     64%|######4   | 226/352 [03:30<00:59,  2.10it/s]     64%|######4   | 227/352 [03:32<01:25,  1.47it/s]     65%|######4   | 228/352 [03:33<01:49,  1.13it/s]     65%|######5   | 230/352 [03:33<01:07,  1.81it/s]     66%|######5   | 231/352 [03:35<01:30,  1.33it/s]     66%|######5   | 232/352 [03:36<01:49,  1.09it/s]     67%|######6   | 235/352 [03:37<01:13,  1.59it/s]     67%|######7   | 236/352 [03:39<01:35,  1.21it/s]     67%|######7   | 237/352 [03:39<01:31,  1.25it/s]     68%|######7   | 239/352 [03:40<01:16,  1.48it/s]     68%|######8   | 240/352 [03:42<01:25,  1.31it/s]     68%|######8   | 241/352 [03:42<01:16,  1.44it/s]     69%|######8   | 242/352 [03:43<01:19,  1.38it/s]     69%|######9   | 243/352 [03:44<01:27,  1.24it/s]     69%|######9   | 244/352 [03:45<01:22,  1.30it/s]     70%|######9   | 245/352 [03:46<01:38,  1.08it/s]     70%|######9   | 246/352 [03:46<01:22,  1.29it/s]     70%|#######   | 247/352 [03:47<01:11,  1.46it/s]     70%|#######   | 248/352 [03:47<01:06,  1.57it/s]     71%|#######   | 249/352 [03:49<01:49,  1.07s/it]     71%|#######1  | 250/352 [03:50<01:25,  1.19it/s]     71%|#######1  | 251/352 [03:50<01:12,  1.40it/s]     72%|#######1  | 252/352 [03:51<01:10,  1.41it/s]     72%|#######1  | 253/352 [03:52<01:24,  1.17it/s]     72%|#######2  | 254/352 [03:52<01:12,  1.34it/s]     72%|#######2  | 255/352 [03:53<01:09,  1.40it/s]     73%|#######2  | 256/352 [03:54<01:06,  1.44it/s]     73%|#######3  | 257/352 [03:55<01:17,  1.22it/s]     73%|#######3  | 258/352 [03:56<01:15,  1.24it/s]     74%|#######3  | 259/352 [03:56<01:13,  1.27it/s]     74%|#######3  | 260/352 [03:57<00:59,  1.54it/s]     74%|#######4  | 261/352 [03:58<01:21,  1.12it/s]     74%|#######4  | 262/352 [03:59<01:10,  1.27it/s]     75%|#######4  | 263/352 [03:59<01:09,  1.27it/s]     75%|#######5  | 265/352 [04:01<01:00,  1.45it/s]     76%|#######5  | 266/352 [04:02<01:03,  1.35it/s]     76%|#######5  | 267/352 [04:02<00:54,  1.57it/s]     76%|#######6  | 268/352 [04:02<00:43,  1.94it/s]     76%|#######6  | 269/352 [04:03<00:58,  1.41it/s]     77%|#######6  | 270/352 [04:04<01:04,  1.27it/s]     77%|#######6  | 271/352 [04:05<00:54,  1.50it/s]     77%|#######7  | 272/352 [04:05<00:49,  1.60it/s]     78%|#######7  | 273/352 [04:06<00:43,  1.80it/s]     78%|#######7  | 274/352 [04:07<00:58,  1.32it/s]     78%|#######8  | 275/352 [04:07<00:50,  1.53it/s]     78%|#######8  | 276/352 [04:07<00:41,  1.84it/s]     79%|#######8  | 277/352 [04:08<00:45,  1.65it/s]     79%|#######8  | 278/352 [04:09<00:52,  1.41it/s]     79%|#######9  | 279/352 [04:10<00:49,  1.48it/s]     80%|#######9  | 280/352 [04:10<00:45,  1.60it/s]     80%|#######9  | 281/352 [04:11<00:43,  1.63it/s]     80%|########  | 282/352 [04:12<00:51,  1.36it/s]     80%|########  | 283/352 [04:13<00:49,  1.40it/s]     81%|########  | 284/352 [04:13<00:42,  1.61it/s]     81%|########  | 285/352 [04:13<00:35,  1.87it/s]     81%|########1 | 286/352 [04:14<00:45,  1.47it/s]     82%|########1 | 287/352 [04:15<00:52,  1.24it/s]     82%|########2 | 289/352 [04:16<00:31,  2.01it/s]     82%|########2 | 290/352 [04:17<00:38,  1.61it/s]     83%|########2 | 291/352 [04:18<00:42,  1.43it/s]     83%|########2 | 292/352 [04:18<00:36,  1.67it/s]     83%|########3 | 293/352 [04:18<00:34,  1.71it/s]     84%|########3 | 294/352 [04:19<00:35,  1.62it/s]     84%|########3 | 295/352 [04:20<00:42,  1.34it/s]     84%|########4 | 296/352 [04:20<00:31,  1.79it/s]     84%|########4 | 297/352 [04:21<00:33,  1.63it/s]     85%|########4 | 298/352 [04:22<00:31,  1.73it/s]     85%|########4 | 299/352 [04:23<00:39,  1.35it/s]     85%|########5 | 300/352 [04:23<00:29,  1.75it/s]     86%|########5 | 301/352 [04:24<00:32,  1.58it/s]     86%|########5 | 302/352 [04:24<00:30,  1.65it/s]     86%|########6 | 303/352 [04:25<00:36,  1.34it/s]     86%|########6 | 304/352 [04:25<00:28,  1.67it/s]     87%|########6 | 305/352 [04:26<00:27,  1.70it/s]     87%|########6 | 306/352 [04:27<00:25,  1.80it/s]     87%|########7 | 307/352 [04:28<00:32,  1.37it/s]     88%|########7 | 308/352 [04:28<00:29,  1.49it/s]     88%|########7 | 309/352 [04:29<00:24,  1.75it/s]     88%|########8 | 310/352 [04:29<00:20,  2.01it/s]     88%|########8 | 311/352 [04:30<00:34,  1.20it/s]     89%|########8 | 312/352 [04:31<00:28,  1.41it/s]     89%|########9 | 314/352 [04:31<00:15,  2.46it/s]     89%|########9 | 315/352 [04:33<00:28,  1.28it/s]     90%|########9 | 316/352 [04:33<00:25,  1.42it/s]     90%|######### | 318/352 [04:34<00:17,  1.97it/s]     91%|######### | 319/352 [04:35<00:24,  1.35it/s]     91%|######### | 320/352 [04:36<00:20,  1.56it/s]     91%|#########1| 321/352 [04:36<00:18,  1.72it/s]     91%|#########1| 322/352 [04:36<00:13,  2.18it/s]     92%|#########1| 323/352 [04:38<00:23,  1.25it/s]     92%|#########2| 324/352 [04:39<00:20,  1.36it/s]     92%|#########2| 325/352 [04:39<00:20,  1.32it/s]     93%|#########2| 326/352 [04:40<00:14,  1.74it/s]     93%|#########2| 327/352 [04:42<00:30,  1.21s/it]     93%|#########3| 329/352 [04:43<00:20,  1.15it/s]     94%|#########4| 331/352 [04:45<00:20,  1.02it/s]     94%|#########4| 332/352 [04:46<00:16,  1.19it/s]     95%|#########4| 333/352 [04:47<00:15,  1.21it/s]     95%|#########4| 334/352 [04:47<00:13,  1.36it/s]     95%|#########5| 335/352 [04:49<00:18,  1.09s/it]     96%|#########5| 337/352 [04:50<00:11,  1.31it/s]     96%|#########6| 338/352 [04:50<00:09,  1.52it/s]     96%|#########6| 339/352 [04:52<00:12,  1.02it/s]     97%|#########6| 341/352 [04:52<00:06,  1.59it/s]     97%|#########7| 342/352 [04:54<00:07,  1.31it/s]     97%|#########7| 343/352 [04:56<00:09,  1.06s/it]     98%|#########7| 344/352 [04:56<00:06,  1.18it/s]     98%|#########8| 345/352 [04:56<00:04,  1.52it/s]     98%|#########8| 346/352 [04:57<00:05,  1.13it/s]     99%|#########8| 347/352 [04:59<00:05,  1.11s/it]     99%|#########8| 348/352 [05:00<00:03,  1.07it/s]     99%|#########9| 350/352 [05:01<00:01,  1.24it/s]    100%|#########9| 351/352 [05:02<00:00,  1.20it/s]    100%|##########| 352/352 [05:02<00:00,  1.16it/s]




.. GENERATED FROM PYTHON SOURCE LINES 243-245

Compare the two gradients
'''''''''''''''''''''''''

.. GENERATED FROM PYTHON SOURCE LINES 245-323

.. code-block:: default


    # Compute NRMSD between AS and FD (%).
    nrmsd = 200*abs(as_grad-fd_grad)/(abs(as_grad)+abs(fd_grad))
    nrmsd[fd_grad == 0] = np.nan

    # Compute sign.
    diff_sign = np.sign(as_grad/fd_grad)


    def plot_diff(ax, diff):
        """Helper routine to show cells of big NRMSD or different sign."""

        for ix in range(comp_grid.h[0].size):
            for iz in range(comp_grid.h[2].size):

                if diff_sign[ix, iy, iz] < 0:
                    ax.add_patch(
                            Rectangle(
                                (comp_grid.nodes_x[ix], comp_grid.nodes_z[iz]),
                                comp_grid.h[0][ix], comp_grid.h[2][iz], fill=False,
                                color='k', lw=1))

                if nrmsd[ix, iy, iz] >= diff:
                    ax.add_patch(
                            Rectangle(
                                (comp_grid.nodes_x[ix], comp_grid.nodes_z[iz]),
                                comp_grid.h[0][ix], comp_grid.h[2][iz], fill=False,
                                color='m', linestyle='--', lw=0.5))


    def set_axis(axs, i):
        """Helper routine to adjust subplots."""

        # Show source and receiver.
        axs[i].plot(rec_coords[0], rec_coords[2], 'bv')
        axs[i].plot(src_coords[0], src_coords[2], 'r*')

        # x-label.
        axs[i].set_xlabel('Easting')

        # y-label depending on column.
        if i == 0:
            axs[i].set_ylabel('Depth')
        else:
            axs[i].set_ylabel('')
            axs[i].axes.yaxis.set_ticklabels([])

        # Set limits.
        axs[i].set_xlim(-3000, 3000)
        axs[i].set_ylim(-4000, -1900)


    # Plotting options.
    vmin, vmax = 1e-2, 1e1
    pcolor_opts = {'cmap': 'RdBu_r',
                   'norm': SymLogNorm(linthresh=vmin, base=10,
                                      vmin=-vmax, vmax=vmax)}

    fig, axs = plt.subplots(figsize=(9, 6), nrows=1, ncols=2)

    # Adjoint-State Gradient
    f0 = comp_grid.plot_slice(as_grad, normal='Y', ind=iy, ax=axs[0],
                              pcolor_opts=pcolor_opts)
    axs[0].set_title("Adjoint-State Gradient")
    set_axis(axs, 0)
    plot_diff(axs[0], 1)

    # Finite-Difference Gradient
    f1 = comp_grid.plot_slice(fd_grad, normal='Y', ind=iy, ax=axs[1],
                              pcolor_opts=pcolor_opts)
    axs[1].set_title("Finite-Difference Gradient")
    set_axis(axs, 1)
    plot_diff(axs[1], 1)

    plt.tight_layout()
    fig.colorbar(f0[0], ax=axs, orientation='horizontal', fraction=0.05)
    plt.show()




.. image:: /gallery/comparisons/images/sphx_glr_as_vs_fd_gradient_002.png
    :alt: Adjoint-State Gradient, Finite-Difference Gradient
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /home/dtr/Codes/emsig/emg3d-gallery/examples/comparisons/as_vs_fd_gradient.py:251: RuntimeWarning: divide by zero encountered in true_divide
      diff_sign = np.sign(as_grad/fd_grad)




.. GENERATED FROM PYTHON SOURCE LINES 324-337

Visually the two gradients are almost identical. This is amazing, given that
the adjoint-state gradient requires one (1) extra forward computation for the
entire cube, whereas the finite-difference gradient requires one extra
forward computation for each cell, for this cross-section 352 (!).

There are differences, and they are highlighted:

  - Cells surrounded by a dashed, magenta line: NRMSD is bigger than 1 %.
  - Cells surrounded by a black line: The two gradients have different signs.

These differences only happen where the amplitude of the gradient is very
small, and it therefore blows the NRMSD numerically up (inherit problem of
the relative error when the signal approaches zero).

.. GENERATED FROM PYTHON SOURCE LINES 338-340

.. code-block:: default


    emg3d.Report()





.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <table style='border: 3px solid #ddd;'>
      <tr>
         <td style='text-align: center; font-weight: bold; font-size: 1.2em; border: 2px solid #fff;' colspan='6'>Sat Jul 17 18:18:01 2021 CEST</td>
      </tr>
      <tr>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>OS</td>
        <td style='text-align: left; border: 2px solid #fff;'>Linux</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>CPU(s)</td>
        <td style='text-align: left; border: 2px solid #fff;'>4</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>Machine</td>
        <td style='text-align: left; border: 2px solid #fff;'>x86_64</td>
      </tr>
      <tr>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>Architecture</td>
        <td style='text-align: left; border: 2px solid #fff;'>64bit</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>RAM</td>
        <td style='text-align: left; border: 2px solid #fff;'>15.5 GiB</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>Environment</td>
        <td style='text-align: left; border: 2px solid #fff;'>Python</td>
      </tr>
      <tr>
         <td style='text-align: center; border: 2px solid #fff;' colspan='6'>Python 3.9.4 | packaged by conda-forge | (default, May 10 2021, 22:13:33) 
    [GCC 9.3.0]</td>
      </tr>
      <tr>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>numpy</td>
        <td style='text-align: left; border: 2px solid #fff;'>1.21.0</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>scipy</td>
        <td style='text-align: left; border: 2px solid #fff;'>1.7.0</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>numba</td>
        <td style='text-align: left; border: 2px solid #fff;'>0.53.1</td>
      </tr>
      <tr>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>emg3d</td>
        <td style='text-align: left; border: 2px solid #fff;'>1.1.0</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>empymod</td>
        <td style='text-align: left; border: 2px solid #fff;'>2.1.2</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>xarray</td>
        <td style='text-align: left; border: 2px solid #fff;'>0.18.2</td>
      </tr>
      <tr>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>discretize</td>
        <td style='text-align: left; border: 2px solid #fff;'>0.7.0</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>h5py</td>
        <td style='text-align: left; border: 2px solid #fff;'>3.3.0</td>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>matplotlib</td>
        <td style='text-align: left; border: 2px solid #fff;'>3.4.2</td>
      </tr>
      <tr>
        <td style='text-align: right; background-color: #ccc; border: 2px solid #fff;'>tqdm</td>
        <td style='text-align: left; border: 2px solid #fff;'>4.61.2</td>
        <td style= border: 2px solid #fff;'></td>
        <td style= border: 2px solid #fff;'></td>
        <td style= border: 2px solid #fff;'></td>
        <td style= border: 2px solid #fff;'></td>
      </tr>
      <tr>
         <td style='text-align: center; background-color: #ddd;border: 2px solid #fff;' colspan='6'>Intel(R) oneAPI Math Kernel Library Version 2021.2-Product Build 20210312 for Intel(R) 64 architecture applications</td>
      </tr>
    </table>
    </div>
    <br />
    <br />


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 5 minutes  27.832 seconds)

**Estimated memory usage:**  9 MB


.. _sphx_glr_download_gallery_comparisons_as_vs_fd_gradient.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: as_vs_fd_gradient.py <as_vs_fd_gradient.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: as_vs_fd_gradient.ipynb <as_vs_fd_gradient.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
